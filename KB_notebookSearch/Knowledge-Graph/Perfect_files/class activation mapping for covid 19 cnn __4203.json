{"name": "class activation mapping for covid 19 cnn ", "full_name": " h1 Introduction and Set up h1 Load the images h1 Visualize our images h1 Load in our saved model h1 Evaluate our model h1 Grad CAM Setup h1 Make grad CAM heatmap h1 Define superimposing function h1 Visualize class activation mapping ", "stargazers_count": 0, "forks_count": 0, "description": "To start let s first look at the structure of our model. resize the image to the desired size. Our original model from the pneumonia notebook was used as a binary classifier but our dataset has three classes. Keras has an easy API to just load in previously trained models. That s not a problem because we can look at the structures of internal models as well. The Grad CAM visualizations may help pinpoint what differentiates these classes of images. Visualize class activation mappingLet s compare what the model uses to classify COVID 19 X rays versus Pneumonia X rays. In this notebook we re going to be using Grad CAM to see what parts of the image are important for the CNN when classifying between COVID 19 and pneumonia X rays. 1 0 0 means NORMAL. Therefore before we train our model we have to pop our top level classifying layer and replace it with a 3 node dense layer. Thankfully Keras API makes this change simple. Evaluate our modelWe correctly classify all of our testing images as well Even though we had a very limited number of images we could build a great model by loading in a pre trained model. Because I used Sequential instead of Functional API for my pneumonia model in my other notebook the blocks that I used show us as nested Sequential models instead of as individual layers. The following functions will help us format our dataset into the necessary image label tuple for easy training. Grad CAM SetupCheck out Keras IO Grad CAM Code Example https keras. The flatten layer and the layers that follow it does the classifying for us so we ll label layers 5 as our classifying layers. Before we run our notebook make sure to change the accelerator to TPU for quick training. One of the hardest aspects of computational biology is maneuvering the differences between biological vs computational significance. We need to get the output of the last convolution layer. cache filename to cache preprocessing work for datasets that don t fit in memory. Make grad CAM heatmapLet s define our grad CAM function. Parts of the image that are redder on the rainbow spectrum are the more important parts of the image as defined by the CNN and purple parts of the image are less important. The weights of the model will be preserved as well. For the Pnueumonia images at least for the 10 images shown here it seems that images are seen in a more holistic manner than the COVID 19 images by the model. Having collaborative discussions with experts in both fields will help answer some of these questions. io examples vision grad_cam for the original source code. For our model this would be the convolution layer within our sequential_3 model in our summary above. We also one hot encode our labels i. This may be biologically significant or it may be an artificial artifact of the model. convert the path to a list of path components The second to last is the class directory convert the compressed string to a 3D uint8 tensor Use convert_image_dtype to convert to floats in the 0 1 range. Define the function to get a NumPy repressentation of our image. We also need to specifiy our classifying layers. We need to identify our last convolution layer. First let s define an early stopping callback. com amyjang tensorflow pneumonia classification on x rays. Looking at the rest of the images will give us a clearer picture. last convolution block of the model array is a float32 NumPy array We add a dimension to transform our array into a batch of size 1 180 180 3 First we create a model that maps the input image to the activations of the last conv layer Mark the classifying layers Second we create a model that maps the activations of the last conv layer to the final class predictions Then we compute the gradient of the top predicted class for our input image with respect to the activations of the last conv layer Compute activations of the last conv layer and make the tape watch it Compute class predictions This is the gradient of the top predicted class with regard to the output feature map of the last conv layer This is a vector where each entry is the mean intensity of the gradient over a specific feature map channel We multiply each channel in the feature map array by how important this channel is with regard to the top predicted class The channel wise mean of the resulting feature map is our heatmap of class activation For visualization purpose we will also normalize the heatmap between 0 1 Prepare image Generate class activation heatmap Rescale the original image We rescale heatmap to a range 0 255 We use jet colormap to colorize heatmap We use RGB values of the colormap We create an image with RGB colorized heatmap Superimpose the heatmap on original image. From an initial analysis it may seem that COVID 19 and pneumonia images will be relatively similar given than many cases of COVID 19 cause pnuemonia. For this set of 10 COVID 19 images it seems that our model focuses on one lung more than the other. Define superimposing functionLet s superimpose the heatmap on the original image to visualize what the CNN marks as important and is used to classify the image. Visualize our images Load in our saved modelWe want to load in the model from the pneumonia notebook https www. However we ve only displayed 20 images here. The top two rows are COVID 19 images and the botton two rows are Pneumonia images. Since we only need the outputs of the layer and not the actual layer itself we can specify sequential_3 our 7th layer in oour model as the last convolution layer. load the raw data from the file as a string This is a small dataset only load it once and keep it in memory. It helps visualize what the important parts of your image are for classification. Load the imagesDivide the set into training validation and testing sets. Introduction and Set upGradient weighted class activation mapping is a great way to better understand what s happening in your CNN. ", "id": "amyjang/class-activation-mapping-for-covid-19-cnn", "size": "4203", "language": "python", "html_url": "https://www.kaggle.com/code/amyjang/class-activation-mapping-for-covid-19-cnn", "git_url": "https://www.kaggle.com/code/amyjang/class-activation-mapping-for-covid-19-cnn", "script": "process_path KaggleDatasets tensorflow get_label matplotlib.cm decode_img superimposed_cam matplotlib.pyplot train_test_split show_batch get_img_array keras kaggle_datasets sklearn.model_selection pandas prepare_for_training make_gradcam_heatmap numpy ", "entities": "(('more important parts', 'purple image'), 'be') (('actual we', 'convolution last layer'), 'need') (('images', 'model'), 'seem') (('We', 'also classifying layers'), 'need') (('grad CAM heatmapLet', 'CAM grad function'), 'make') (('Keras', 'just previously trained models'), 'have') (('model', 'Pneumonia X rays'), 'compare') (('model', 'more other'), 'seem') (('great better what', 'CNN'), 'be') (('I', 'instead individual layers'), 'use') (('We', 'convolution last layer'), 'need') (('we', 'pre trained model'), 'evaluate') (('so we', '5 classifying layers'), 'do') (('biologically it', 'artificial model'), 'be') (('Define superimposing functionLet', 'CNN important image'), 'superimpose') (('This', 'memory'), 'load') (('One', 'computational significance'), 'maneuver') (('First s', 'stopping early callback'), 'let') (('Having', 'questions'), 'help') (('us', 'easy training'), 'help') (('this', 'summary'), 'be') (('parts', 'when COVID'), 'go') (('s', 'model'), 'start') (('important parts', 'classification'), 'help') (('we', 'internal models'), 's') (('weights', 'model'), 'preserve') (('However we', 've only 20 images'), 'display') (('Looking', 'clearer picture'), 'give') (('we', 'node 3 dense layer'), 'have') (('we', 'quick training'), 'make') (('relatively many cases', '19 pnuemonia'), 'seem') (('what', 'images'), 'help') (('dataset', 'three classes'), 'use') (('class directory', '0 1 range'), 'convert') (('We', 'original image'), 'be') "}