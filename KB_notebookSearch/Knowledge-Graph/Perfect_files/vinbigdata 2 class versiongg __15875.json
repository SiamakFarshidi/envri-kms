{"name": "vinbigdata 2 class versiongg ", "full_name": " h1 VinBigData 2 class classifier complete pipeline h1 Table of Contents h1 Dataset preparation h1 Installation h1 EDA distribution between normal abnormal class h1 Image visualizaion augmentation with albumentations h1 Defining CNN models h1 Training utils h1 Training scripts h2 Preparing data by 5 fold cross validation h2 Write training code h1 Prediction on validation test dataset h1 Apply 2 class filter on detection prediction h3 If this kernel helps you please upvote to keep me motivated Thanks h1 Next step h1 Next to read ", "stargazers_count": 0, "forks_count": 0, "description": "com pytorch ignite Traning Evaluation abstraction framework on top of pytorch. 0 remove all detection predictoin. 053 just adding 14 1 0 0 1 1 https www. com corochann vinbigdata detectron2 train currently only uses abnormal image during training and model tend to produce more abnormal boxes. com corochann vinbigdata detectron2 train kernel explains how to run object detection training using detectron2 library. com pytorch pytorch Deep learning framework it s popular among researchers for its flexible usage. Here cosine annealing is applied configured by Flags by calling scheduler. You may wonder which model should be used I will go with resnet18 as a baseline at first and try using more deeper latest models in the experiment. pytorch pfn extras https github. com c vinbigdata chest xray abnormalities detection discussion 207955. I also noticed that setting high_threshold value less than 1 is important which means we have a benefit to remove abnormality predictions for the images which is highly likely to be normal. p Do nothing Keep det prediction. I m now thinking that it s better to include normal images for training to learn where there is no abnormality. You can try changing training configurations by just changing Flags flags_dict configuration. plotly models setup General Data config split_mode str all_train all_train or valid20 0 4 Model config normal cnn_fixed supported Training config negative value is to inactivate ema. Below updated Transform function is written to support all the augmentations implemented in albumentations. 206 This post process combine replace add 0. com c vinbigdata chest xray abnormalities detection discussion 211971 Here I will propose new post processing similar to this https www. com facebookresearch detectron2 blob master INSTALL. print row print row class_name class_name row class_name It is No finding This annotator does not find anything skip. When False original model s parameter is used. org stable modules generated sklearn. Add keep det preds and add normal pred. com c vinbigdata chest xray abnormalities detection discussion 208837 Here I will introduce complete EDA Training with 5 fold cross validation and Prediction pipeline for training 2 class classifier. 221 So the score improved by about 0. You can learn the usage of following tools to accelerate deep learning tasks in computer vision pytorch https github. I ll show examples to use Albumentations to run image augmentation very easily. read_csv imgdir test_meta. Even you quit training using Ctrl C without finishing all the epoch the intermediate trained model is saved and you can use it for inference. We can use cross validation to reduce validation error standard deviation. com pfnet pytorch pfn extras It provides several extensions useful for training. Please upvote his kernel as well Also it is mentioned that we can submit 14 prob 1 1 0 0 where the prob is the normal probability in the discussion Scoring bug Improve your LB score by 0. So it may be okay to set low_threshold 0. Note I also wrote another kernel to train 2 class model VinBigData 2 class classifier complete pipeline https www. com albumentations team albumentations page that various kinds of augmentation is already implemented and can be used very easily To use augmentation you can just define dataset with the Transform function. no need to explain detail albumentations https github. Note I noticed that it does not apply for the other classes. com rwightman pytorch image models pytorch image models it provides a lot of popular SoTA CNN models with pretrained weights. Run evaluation for valid dataset in each epoch. 8 which is significant In more detail I tried to change several low_threshold value and lower low_threshold achieved better results. However you need to be careful that 3 radiologists annotated for each image so you can find 3 annotations as you can see below. 0 which means always add No finding prediction with the predicted probability. Load 1 image to get image size. 5 CoarseDropout max_holes 8 max_height 25 max_width 25 p 0. It is classified as class_name No finding and class_id 14. So you can follow how the learning rate changed through the training. Here I will use StratifiedKFold https scikit learn. com corochann lyft training with multi mode confidence So what is happening in above training abstraction Let s understand what each extension did. record image_id index objs record annotations objs 0 normal 1 abnormal Only return img Only return img Each time the data is accessed the result is different due to random augmentation We do not learn CNN parameters. com ja jp photo 4989186 VinBigData 2 class classifier complete pipelineThis competition is object detaction task to find a class and location of thoracic abnormalities from chest x ray image radiographs. You can refer albumentations https github. 5 ShiftScaleRotate scale_limit 0. snapshot_object predictor best_predictor. md we need to know CUDA and pytorch version to install correct detectron2. Here the model is saved in regular interval flags. I will use timm this time. You can specify aug_kwargs from external configuration inside flag as follows aug_kwargs HorizontalFlip p 0. pfnet pytorch pfn extras https github. p Keep Do nothing Keep det prediction. At first I will define pytorch Dataset class for this competition which can be also used later in the training. snapshot_freq iteration lr scheduler Exponential moving average Prediction valid data test data Test dataset prediction result You can load from another submission. Let s visualize looks good. com trent b iterative stratification may be more stable. 141 Just replace by threshold version3 https www. 5 RandomBrightnessContrast p 0. So the question arises is there an image that the 3 radiologists opinions differ Let s check number of No finding annotations for each image if the opinions are in complete agreement the number of No finding annotations should be 0 Abnormal all radiologists does not think this is normal or 1 Normal all radiologists think this is normal. com download storage v1 b kaggle forum message attachments o inbox 2F518134 2F68421364ae2731375c0f59fd1749c845 2Fpexels ivan samkov 4989186. Only 30 of the images need thoracic abnormality location detection. pytorch ignite https github. report see LyftMultiRegressor for reporting point method and save to log file. You can obtrain training history results really easily by just accessing LogReport class which is useful for managing a lot of experiments during kaggle competitions. ProgressBar update_interval 10 if debug else 100 Show progress bar during training E. io pytorch image models feature_extraction Assumes first argument is image NOQA Flag to manage which parameter is assigned. 3 RandomGamma gamma_limit 80 120 p 0. com corochann vinbigdata2classpred. My basic strategy is as follows Check training loss training accuracy If it is almost same with validation loss accuracy and it is not accurate enough model s representation power may be not enough or data augmentation is too strong. com pfnet pytorch pfn extras It is used to add more feature rich functionality on Ignite. Try using smaller models increase data augmentation or apply regularization dropout etc. Apply mixup augmentation when positive value is set. 5 Blur blur_limit 3 7 p 0. jpg generation 1611197793386796 alt media Image from https www. Note Why training abstraction library is used You may feel understanding training abstraction code below is a bit unintuitive compared to writing raw training loop. LRScheduler You can insert learning rate scheduling with this extension together with the regular interval call specified by trigger. Table of Contents Dataset preparation dataset Installation installation EDA distribution between normal abnormal class eda Image visualizaion augmentation with albumentations aug Defining CNN models model Training utils trainutil Training scripts trainscript Prediction on validation test dataset prediction Next step nextstep Dataset preparationPreprocessing x ray image format dicom into normal png image format is already done by xhlulu in the below discussion Multiple preprocessed datasets 256 512 1024px PNG and JPG modified and original ratio https www. You don t need to impelment deep CNN models by yourself you can just re use latest research results without hustle. VinBigData detectron2 prediction https www. This Flags class summarizes all the configuratoin available during the training. Replace remove all det preds. html normal configuration. pt trigger MinValueTrigger validation module nll trigger flags. According to this discussion https www. However it is mentioned that training 2 class classifier to understand which is the normal image is important to get high score. This may be because my training kernel https www. It automatically collects reported value in each iteration and saves the mean of reported value for regular frequency for example every 1 epoch. Prediction on validation test dataset Apply 2 class filter on detection predictionI will use detection prediction from the kernel VinBigData detectron2 train https www. high_threshold Replace Replace with Normal prediction Keep do nothing. snapshot_object Saves the object. Here I will just use the dataset VinBigData Chest X ray Resized PNG 256x256 https www. com awsaf49 vinbigdata 2 class filter by awsaf49 applying 2 class filter improves LB score significantly. Write training codepytorch ignite pytorch pfn extras are used here. bbox_original int row x_min int row y_min int row x_max int row y_max test_meta pd. You can see each image looks different rotated brightness is different etc. normal configuration. com c vinbigdata chest xray abnormalities detection discussion 208837 1139712 using multi label stratified kfold https github. Overwrite by param_dict Change to True for fast debug run Data Model Training 15000 15 epoch batchsize 8 args parse Read data Read in the data CSV files sample_submission pd. As mentioned in VinBigData 2 Class Filter https www. Extensions Each role ProgressBar ProgressBarNotebook Shows training progress in formatted style. The advantage of abstracting the code is that we can re use implemented handler class for other training other competition. To run augmentation on this image I will define Transform class which is applied each time the data is accessed. com corochann vinbigdata detectron2 train VinBigData detectron2 prediction https www. com xhlulu vinbigdata chest xray resized png 256x256 to skip the preprocessing and focus on modeling part. What kind of models are supported in the timm library Wow more than 300 models are supported It of course includes resnet related models efficientnet etc. You can just copy these to use in other projects. For example you can change these paramters Data imgdir_name You can use different preprocessed image introduced in Multiple preprocessed datasets 256 512 1024px PNG and JPG modified and original ratio https www. com albumentations team albumentations Image augmentation library developed by famous kagglers timm https github. Evaluator Evaluate on validation dataset. train all parameters. You don t need to write code for saving models logging training loss metric show progressbar etc. read_csv datadir sample_submission. pt every epoch Check Save best validation predictor. get_n_splits None None 0th fold optimizer optim. https rwightman. Training scripts Preparing data by 5 fold cross validationWhen we have few data running stable evaluation is very important. As I will show later you can change various hyperparameters to experiment improving your models EDA distribution between normal abnormal classAt first let s check how many normal class exist in the training data. com corochann vinbigdata detectron2 prediction And 2class prediction is updated as dataset vinbigdata 2class pred https www. PrintReport PrintReportNotebook Prints the value which LogReport collected in formatted style. PrintReport Print log to terminal Stop training when nan is detected. high_threshold Replace with Normal prediction with normal score 1. pt every epoch manager. com corochann vinbigdata 2 class classifier complete pipeline to train these 2 class classifier model In my experiment The baseline submission score 0. 155 baseline solution https www. org tutorials beginner finetuning_torchvision_models_tutorial. 5 Downscale scale_min 0. even if it is generated from the same image Extend to more general form Augmentation is very important hyperparameter to improve model s performance and you want to experiment with various configurations. Such many functionalities can be added easily using extensions Also Exponential Moving Average of model weights is calculated by EMA class during training together with showing its validation loss. You can focus on more about looking data and try experiment now. step every iteration. 3 radiologists opinions sometimes do not match for the other class of thoracic abnormalities. com awsaf49 vinbigdata 2 class filter Discussion LB0. 15 rotate_limit 10 p 0. Training utilsHere are training util methods. com corochann vinbigdata detectron2 prediction scriptVersionId 52412540 score 0. Next to read VinBigData detectron2 train https www. log_trigger 10 if debug else 1000 iteration Show progress bar during training Show log on jupyter notebook E. Register model parameters alias skf. Image visualizaion augmentation with albumentationsWhen you train CNN models image augmentation is important to avoid model to overfit. Kernel VinBigData 2 Class Filter https www. We could confirm that always 3 radiologists opinions match for normal abnormal diagnosis. com pytorch ignite It provides abstraction for writing training loop. low_threshold Just Add Normal prediction keep detection prediction. Model model_name You can try various kinds of models timm library support by just changing model_name. We can usually obtrain more stable models with EMA. We can follow installation instruction https github. When True assign method is called shadow parameter ema param is used. Training epoch batch_size scheduler_type etc Try changing these hyperparamters to see the difference Augmentation Please modify Transform class to add your augmentation it s easy to support more augmentations with albumentations library. These are done by provided util classes in pytorch pfn extras library You may refer my other kernel in previous competition too Bengali SEResNeXt training with pytorch https www. com c vinbigdata chest xray abnormalities detection discussion 207955 by xhlulu. com corochann vinbigdata detectron2 prediction kernel explains how to use trained model for the prediction and submisssion for this competition. com corochann bengali seresnext training with pytorch Lyft Training with multi mode confidence https www. 6 Defining CNN modelsRecently several libraries of CNN collection are available on public. Please upvote the dataset as well Installationdetectron2 is not pre installed in this kaggle docker so let s install it. So almost 70 of the data is actually Normal X ray images. observe_lr LogReport will check optimizer s learning rate using this extension. LogReport Logging metrics reported by ppe. Check training loss validation loss difference If validation loss is very high compared to training loss it is a sign of overfitting. That s all If this kernel helps you please upvote to keep me motivated Thanks Next stepI explained EDA Training Prediction pipeline for 2 class image classification in this kernel. Useful for logging printing evaluating saving the model scheduling the learning rate during training. parameters lr 1e 3 Train setup HACKING report ema value with prefix. Now creating the dataset is just easy as following You can access each image and its label 0 Normal 1 Abnormal by just access dataset with index. Also I think it s nice to try including No finding class during detection training by adding virtual No finding boxes or by adding global classifier together with the detection. com c vinbigdata chest xray abnormalities detection discussion 211971 1157809 by pestipeti Here p is the normal probability. html to keep the balance between normal abnormal ratio same for the train validation dataset. You can try more deeper models decrease data augmentation or using more rich data high resolution image. low_threshold Add Just Add Normal prediction 3. ", "id": "ghaiyur/vinbigdata-2-class-versiongg", "size": "15875", "language": "python", "html_url": "https://www.kaggle.com/code/ghaiyur/vinbigdata-2-class-versiongg", "git_url": "https://www.kaggle.com/code/ghaiyur/vinbigdata-2-class-versiongg", "script": "update_fn tools lightgbm get_example albumentations dataclasses DataLoader pathlib plotly.express Extension Optional preprocessing Path step getLogger pytorch_pfn_extras.training.extension field plotly.io scipy matplotlib.pyplot torch.utils.data.dataloader DatasetMixin(Dataset) Dataset optim get_vinbigdata_dicts_test torch __getitem__ torch.nn.functional get_vinbigdata_dicts pytorch_pfn_extras.training.manager detectron2.structures Transform catboost Tuple Flags LRScheduler(Extension) eval_func torch.nn state_dict sklearn StratifiedKFold predict_proba plotly.graph_objs pandas pytorch_pfn_extras.training.extensions Mapping __len__ display CNNFixedPredictor(nn.Module) subplots List Linear cross_entropy_with_logits IPython.core.display save_yaml numpy dataclass plotly load_state_dict Any pytorch_pfn_extras EMA(object) typing plotly.offline tqdm.notebook VinbigdataTwoClassDataset(DatasetMixin) logging plotly.figure_factory HTML save_ema_model ignite.engine assign IgniteExtensionsManager torch.utils.data.dataset build_predictor PRIORITY_READER __call__ pytorch_pfn_extras.training Events predict xgboost update Union seaborn accuracy_with_logits _get_single_example get_example_wrapper nn tqdm create_trainer resume Dict KFold accuracy forward sklearn.model_selection Classifier(nn.Module) BoxMode __init__ ExtensionsManager Engine ", "entities": "(('com corochann bengali seresnext', 'Lyft mode confidence https multi www'), 'training') (('None None 0th', 'optimizer optim'), 'fold') (('lower low_threshold', 'better results'), '8') (('just You', 'index'), 'be') (('Training', 'utilsHere methods'), 'train') (('It', 'models efficientnet resnet related etc'), 'support') (('it', 'together detection'), 'think') (('it', 'albumentations library'), 'epoch') (('time data', 'Transform class'), 'define') (('Exponential Moving Also Average', 'validation together loss'), 'add') (('Here I', 'https StratifiedKFold scikit'), 'use') (('1024px preprocessed 256 512 PNG', 'Multiple'), 'change') (('observe_lr LogReport', 'extension'), 'check') (('you', 'Transform function'), 'page') (('so s', 'it'), 'upvote') (('com c vinbigdata chest xray abnormalities detection 211971 Here I', 'https similar www'), 'discussion') (('Only 30', 'thoracic abnormality location detection'), 'need') (('I', 'experiment'), 'wonder') (('aug_kwargs HorizontalFlip', 'flag'), 'specify') (('Here I', 'just dataset'), 'use') (('now it', 'training'), 'think') (('com pytorch It', 'training loop'), 'ignite') (('Next stepI', 'kernel'), 's') (('com pytorch learning Deep framework it', 'flexible usage'), 'pytorch') (('Try', 'regularization dropout etc'), 'increase') (('Model You', 'just model_name'), 'model_name') (('epoch Check', 'validation best predictor'), 'pt') (('You', 'Flags flags_dict just changing configuration'), 'try') (('com corochann vinbigdata detectron2 train kernel', 'detectron2 library'), 'explain') (('it', 'overfitting'), 'check') (('ProgressBar ProgressBarNotebook Shows', 'formatted style'), 'extension') (('You', 'other projects'), 'copy') (('how many normal class', 'training data'), 'change') (('pipelineThis competition', 'chest ray image radiographs'), 'com') (('1024px 256 512 PNG', 'below discussion'), 'dataset') (('So it', 'low_threshold'), 'be') (('Transform updated function', 'albumentations'), 'write') (('Scoring bug', '0'), 'upvote') (('Training config negative value', 'ema'), 'model') (('radiologists always 3 opinions', 'normal abnormal diagnosis'), 'confirm') (('normal image', 'high score'), 'mention') (('You', 'submission'), 'result') (('This', 'training kernel https www'), 'be') (('you', '3 annotations'), 'need') (('So almost 70', 'data'), 'be') (('this', 'finding annotations'), 'be') (('learning how rate', 'training'), 'follow') (('understanding', 'training below bit raw loop'), 'note') (('We', 'EMA'), 'obtrain') (('data enough augmentation', 'validation loss almost accuracy'), 'be') (('com corochann vinbigdata detectron2 2class prediction', 'dataset vinbigdata https 2class pred www'), 'prediction') (('You', 'albumentations https github'), 'refer') (('when positive value', 'mixup augmentation'), 'apply') (('com albumentations team albumentations Image augmentation library', 'https github'), 'timm') (('md we', 'pytorch correct detectron2'), 'need') (('LRScheduler You', 'trigger'), 'insert') (('you', 'inference'), 'quit') (('com pfnet pytorch pfn It', 'useful training'), 'extras') (('LogReport Logging metrics', 'ppe'), 'report') (('You', 'experiment'), 'focus') (('Flags class', 'available training'), 'summarize') (('Here model', 'regular interval flags'), 'save') (('You', 'resolution more rich data high image'), 'try') (('extension', 'what'), 'training') (('class Apply 2 filter', 'detectron2 train https VinBigData www'), 'prediction') (('We', 'CNN parameters'), 'image_id') (('We', 'validation error standard deviation'), 'use') (('class_name', 'finding'), 'classify') (('radiologists 3 opinions', 'thoracic abnormalities'), 'match') (('LogReport', 'formatted style'), 'Prints') (('report', 'log file'), 'see') (('It', '1 epoch'), 'collect') (('15000 15 epoch', 'Read data CSV 8 args files'), 'run') (('few data', 'stable evaluation'), 'script') (('Here p', 'com c vinbigdata chest xray abnormalities detection 211971 1157809 pestipeti'), 'discussion') (('Train setup HACKING 3 report', 'prefix'), 'parameters') (('com xhlulu vinbigdata chest xray', 'part'), 'resize') (('I', 'image augmentation'), 'show') (('com rwightman pytorch image models pytorch image it', 'pretrained weights'), 'model') (('low_threshold', 'Just Normal prediction'), 'add') (('com pfnet pytorch pfn It', 'Ignite'), 'extras') (('ProgressBar 10 debug', 'Show progress else 100 E.'), 'update_interval') (('vinbigdata class com awsaf49 2 filter', 'LB score'), 'improve') (('it', 'other classes'), 'notice') (('I', 'class VinBigData class classifier complete pipeline https 2 model 2 www'), 'note') (('10 debug', 'jupyter notebook E.'), 'log_trigger') (('We', 'installation instruction https github'), 'follow') (('CNN models image augmentation', 'overfit'), 'be') (('post process', '0'), '206') (('You', 'training loss show progressbar metric etc'), 'need') (('You', 'pytorch https www'), 'do') (('cosine Here annealing', 'scheduler'), 'apply') (('com c vinbigdata chest xray abnormalities detection 208837 Here I', 'Prediction class 2 classifier'), 'discussion') (('you', 'hustle'), 'need') (('which', 'also later training'), 'define') (('com corochann vinbigdata detectron2 train', 'more abnormal boxes'), 'use') (('we', 'handler implemented other training other competition'), 'be') (('image NOQA parameter', 'pytorch image models'), 'io') (('Just Normal prediction', 'detection prediction'), 'add') (('You', 'computer vision pytorch https github'), 'learn') (('which', 'predicted probability'), 'add') (('you', 'various configurations'), 'be') (('which', 'kaggle competitions'), 'obtrain') (('modelsRecently several libraries', 'public'), 'be') (('com corochann vinbigdata detectron2 prediction kernel', 'competition'), 'explain') (('which', 'images'), 'notice') (('high_threshold Replace Replace', 'nothing'), 'do') "}