{"name": "visual in depth eda siim covid19 detection ", "full_name": " h1 Visual In Depth EDA SIIM COVID19 Detection h2 Exploratory Data Analysis EDA h2 TABLE OF CONTENTS h2 0 xa0 xa0 xa0 xa0IMPORTS h2 1 xa0 xa0 xa0 xa0BACKGROUND INFORMATION h2 2 xa0 xa0 xa0 xa0SETUP h2 3 xa0 xa0 xa0 xa0HELPER FUNCTIONS h2 4 xa0 xa0 xa0 xa0TABULAR DATA h2 5 xa0 xa0 xa0 xa0IMAGE DATA h2 6 xa0 xa0 xa0 xa0IDENTIFY DUPLICATES h1 0 xa0 xa0IMPORTS h1 1 xa0 xa0BACKGROUND INFORMATION h2 1 1 THE DATA h2 1 2 THE GOAL h2 1 3 ADDITIONAL INFORMATION ON ABNORMALITIES h1 2 xa0 xa0NOTEBOOK SETUP h1 3 xa0 xa0HELPER FUNCTIONS h1 4 xa0 xa0TABULAR DATA h2 4 1 IMAGE ID COLUMN EXPLORATION h2 4 2 HUMAN LABEL COLUMN EXPLORATION h2 4 3 EXPLORATION OF BBOX COORDINATE COLUMNS h1 5 xa0 xa0IMAGE DATA h2 5 1 CLASS TO HELP PARSE THE DATA h2 5 2 VISUALIZE EACH TYPE OF BBOX ", "stargazers_count": 0, "forks_count": 0, "description": "2 VISUALIZE EACH TYPE OF BBOX TBDATYPICAL 0 Summary to be done later. For a given patient image we also know that all the detections are the same label. we should be able to infer on the entirety of the training dataset within the submission kernelDATA FILES train_study_level. intersecting_boxes. cvtColor dicom2array image_annots 0 img_path cv2. TOTAL OPACITIES PER IMAGE PATIENTLet s count the distribution of the amount of annotations per unique id value. More detail to come laterTYPICAL 3 Summary to be done later. figure figsize 20 height_multiplier n for i image_id annots in enumerate annotations. 1 IMAGE_ID COLUMN EXPLORATION The id column contains a U nique ID entifier UID that indicates which deidentified patient the respective row object relates to. show def plot_classes self class_list n 4 height_multiplier 6 verbose True annotations self. plot_classes class_list 7 n 2 verbose False train_data. class_id 14 gt_df bbox gt_df. get_annotated_image image_id annots plt. drop columns bbox inplace True gt_df pd. More detail to come laterNEGATIVE 2 Summary to be done later. Journal of thoracic imaging. loc train_df class_id 14. 3 ADDITIONAL INFORMATION ON ABNORMALITIES Negative for Pneumonia No lung opacitiesTypical Appearance Multifocal bilateral peripheral opacities with rounded morphology lower lung predominant distributionIndeterminate Appearance Absence of typical findings AND unilateral central or upper lung predominant distributionAtypical Appearance Pneumothorax pleural effusion pulmonary edema lobar consolidation solitary lung nodule or mass diffuse tiny nodules cavity2 nbsp nbsp NOTEBOOK SETUP3 nbsp nbsp HELPER FUNCTIONS4 nbsp nbsp TABULAR DATAWE ARE GIVEN AND HAVE CREATED THE FOLLOWING TRAIN COLUMNS id unique image identifier UID dcm_path Path to the respective detection s dicom image xmin minimum X coordinate of the object s bounding box ymin minimum Y coordinate of the object s bounding box xmax maximum X coordinate of the object s bounding box ymax maximum Y coordinate of the object s bounding box human_label Which category is this rows detection negative boolean label typical boolean label indeterminate boolean label atypical boolean label StudyInstanceUID Study UID SeriesInstanceUID Series UID ImageInstanceUID Series UID image_shape Image shape from dicom meta width Self explanatory height Self explanatory integer_label Integer label instead of human readable. pop 2 tmp_numpy self. append other_bbox if len intersecting_boxes 1 inner_box _get_inner_box intersecting_boxes if inner_box and inner_box not in new_bboxes new_bboxes. As this is a kernels only competition we shsould plan accordingly i. isin rad_ids if index is not None tmp_df tmp_df. subplot n 2 2 i 1 plt. Review of chest radiograph findings of COVID 19 pneumonia and suggested reporting language. isin image_ids if class_ids is not None tmp_df tmp_df tmp_df. apply lambda x x 3 gt_df. index 0 100 20 for i IMAGE_ID in enumerate IMAGE_ID_LIST train_data. Visual In Depth EDA SIIM COVID19 DetectionExploratory Data Analysis EDA CREATED BY DARIEN SCHETTLER TABLE OF CONTENTS 0 nbsp nbsp nbsp nbsp IMPORTS 1 nbsp nbsp nbsp nbsp BACKGROUND INFORMATION 2 nbsp nbsp nbsp nbsp SETUP 3 nbsp nbsp nbsp nbsp HELPER FUNCTIONS 4 nbsp nbsp nbsp nbsp TABULAR DATA 5 nbsp nbsp nbsp nbsp IMAGE DATA 6 nbsp nbsp nbsp nbsp IDENTIFY DUPLICATES 0 nbsp nbsp IMPORTS1 nbsp nbsp BACKGROUND INFORMATION 1. com thoracicimaging Fulltext 2020 11000 Review_of_Chest_Radiograph_Findings_of_COVID_19. Atypical Appearance Pneumothorax pleural effusion pulmonary edema lobar consolidation solitary lung nodule or mass diffuse tiny nodules cavity4. title f Image ID image_id plt. int32 return annotations def get_annotated_image self image_id annots None plot False plot_size 18 25 plot_title if annots is None annots self. concat gt_df train_df. get_annotations rad_ids rad_id_list annotated_imgs plt. color_palette cmap 4 self. ANNOTATIONS PER CLASSWe know there are 4 different possible human_label s. agg k list for k in gt_df. Indeterminate Appearance Absence of typical findings AND unilateral central or upper lung predominant distribution3. append inner_box new_class_ids. drop_duplicates subset image_id. 1 CLASS TO HELP PARSE THE DATA Classes are very useful when we need to bind data to functionality. Note that all images are stored in paths with the form study series image. Let s visualize what this looks like by the numbers. apply lambda x x 1 gt_df x_max gt_df bbox. The P R curve and AP calculations remain the same. Negative for Pneumonia No lung opacitiesBounding boxes were placed on lung opacities whether typical or indeterminate. isin class_ids if rad_ids is not None tmp_df tmp_df tmp_df. reset_index drop True. append rad_id annots bbox new_bboxes annots rad_id new_rad_ids annots class_id new_class_ids return annots gt_df train_df train_df. More detail to come later5. 2 HUMAN LABEL COLUMN EXPLORATION The human_label column indicates the label as a string for the respective object annotation each row is for one object annotation. 2 THE GOAL In this competition you ll identify and localize COVID 19 abnormalities on chest radiographs. negative for pneumonia or typical indeterminate or atypical You ll work with a dataset consisting of 8 781 scans that have been annotated by experienced radiologists. show train_data TrainData train_df TRAIN_DIR train_data. csv id unique image identifier boxes bounding boxes in easily readable dictionary format label the correct prediction label for the provided bounding boxes1. append dict img_path os. NOTE Only the bounding boxes for the specified classes will be drawn. tight_layout rect 0 0. Example Radiographs https i. 0Further for each test study you should make a determination within the following labels Negative for Pneumonia Typical Appearance Indeterminate Appearance Atypical Appearance To make a prediction of one of the above labels create a prediction string similar to the none class above i. iloc index annotations image_id for image_id in tmp_df. apply redux_bboxes axis 1 gt_df gt_df. More detail to come laterINDETERMINATE 1 Summary to be done later. From the bar chart plotted below we can ascertain the following information 5 nbsp nbsp IMAGE DATARecall that the image data is stored in DICOM format and the annotations are stored in our train_df Dataframe. cmap cmap self. pal ann class_id label int_2_str ann class_id opacity 0. drop columns x_min y_min x_max y_max inplace True gt_df gt_df. NOTE You can have no opacities detected and still have an atypical study level label. For each test image you will be predicting a bounding box and class for all findings. get_annotations get_all True del tmp_numpy gc. count. copy if type annots list image_annots annots image_id else image_annots annots img cv2. The goal in this challenge is to determine the appropriate category for each radiograph as well as localize the lung opacities with a bounding box prediction. Similarly some patients who were COVID positive had atypical appearances or were negative for pneumonia no lung opacities because the grading system is based off the chest radiographic findings alone. More detail to come later6 nbsp nbsp IDENTIFY DUPLICATESFind duplicate images using perceptual hash. sort_values by class_id ascending False. 1. WHAT PERCENTAGE OF IMAGES HAVE BOUNDING BOXESPLOT HEATMAP REPRESENTING BOUNDING BOXES FOR VARIOUS CLASSESThere s a lot to digest within these plots. get_annotations class_ids class_list annotated_imgs plt. of the bouning boxes associated with each class and to do this we will use a bar chart with some pre drawn lines. In particular you ll categorize the radiographs as one of a possible 4 categories. items if i n break if verbose print f. apply lambda x x 0 gt_df y_min gt_df bbox. Typical Appearance Multifocal bilateral peripheral opacities with rounded morphology lower lung predominant distribution2. reset_index drop True gt_data TrainData gt_df TRAIN_DIR IMAGE_ID_LIST gt_df gt_df. aspx Per the grading schema chest radiographs are classified into one of four categories which are mutually exclusive 1. If you predict that there are no findings you should create a prediction of none 1 0 0 1 1 none is the class ID for no finding and this provides a one pixel bounding box with a confidence of 1. to_numpy annotations row 0. You can train your model with 6 334 independently labeled images and you will be evaluated on a test set of 2 447 images. The important thing to focus on will be identifying for each class the approximate range of locations the annotations are found in and the intensity of the locations within the heatmap. 08 line_thickness 4 if plot plot_image img title plot_title figsize plot_size return img def plot_image_ids self image_id_list height_multiplier 6 verbose True annotations self. A value of 0 0 1 1 indicates that no opacities are detected. to_list for row in tmp_df. Annotators did have access to the COVID status for each patient but were asked to adhere to the grading system above irrespective of the status. df df self. plot_classes class_list 5 8 11 n 4 verbose False def calc_iou bbox_1 bbox_2 x_left max bbox_1 0 bbox_2 0 y_top max bbox_1 1 bbox_2 1 x_right min bbox_1 2 bbox_2 2 y_bottom min bbox_1 3 bbox_2 3 if x_right 0. axis False plt. The study ID here relates directly to the study level predictions the image ID is the ID used for image level predictionsThe test dataset is of roughly the same scale as the training dataset. copy if not get_all if image_ids is not None tmp_df tmp_df tmp_df. reset_index gt_df gt_df. If successful you ll help radiologists diagnose the millions of COVID 19 patients more confidently and quickly. get_annotated_image IMAGE_ID annots None plot True plot_size 18 22 plot_title f ORIGINAL xa0IMG i 1 gt_data. Bounding boxes were not placed on pleural effusions or pneumothoraces. probably a TBD in the future as a possible arg More detail to come laterPLOT IMAGES CONTAINING ONE OR MORE CLASSES FROM A LISTSummary to be done later. NOTE Images need not contain ALL the classes. img_annotations self. Note that the images are in DICOM format which means they contain additional data that might be useful for visualizing and classifying. No bounding boxes were placed for the negative for pneumonia category. show def plot_radiologists self rad_id_list n 4 height_multiplier 6 verbose True annotations self. collect def get_annotations self get_all False image_ids None class_ids None rad_ids None index None TBD Args get_all bool optional TBD image_ids list of strs optional TBD class_ids list of ints optional TBD rad_ids list of strs optional TBD index int optional Returns if not get_all and image_ids is None and class_ids is None and rad_ids is None and index is None raise ValueError Expected one of the following arguments to be passed n t t get_all image_id class_id rad_id or index tmp_df self. NUMBER OF ANNOTATIONS FOR THE SAME CLASS PER IMAGEWe know there are 4 different possible human_label s. As there can be up multiple objects within a single radiograph the id column can contain duplicates. PLOT IMAGESSummary to be done later More detail to come laterPLOT IMAGES CONTAINING A SINGLE CLASSSummary to be done later. there is no concept of difficult classes in VOC 2010. Bounding boxes were also placed on some atypical findings including solitary lobar consolidation nodules masses and cavities. csv id unique study identifier Negative for Pneumonia 1 if the study is negative for pneumonia 0 otherwise Typical Appearance 1 if the study has this appearance 0 otherwise Indeterminate Appearance 1 if the study has this appearance 0 otherwise Atypical Appearance 1 if the study has this appearance 0 otherwise train_image_level. apply lambda x x 2 gt_df y_max gt_df bbox. end plt. Note that we use a log axis for the count axis to handle the large number of values where their is only 1 or 2 opacities present. and for today I will simply generate the outputs using each method to show their functionality. to_numpy image_ids tmp_numpy 0 class_ids tmp_numpy 1 rad_ids tmp_numpy 2 bboxes tmp_numpy 3 self. As such some patients who were COVID negative still had chest radiographs with typical appearances. columns if k image_id. The challenge uses the standard PASCAL VOC 2010 mean Average Precision mAP at IoU 0. png DATASET INFORMATIONThe train dataset comprises 6 334 chest scans in DICOM format which were de identified to protect patient privacy. TBD conda install c conda forge gdcm y Machine Learning and Data Science Imports Other Competition Related Imports Built In Imports Visualization Imports LABEL_COLORS_WOUT_NO_FINDING LABEL_COLORS 8 LABEL_COLORS 9 Triple Checks Define the root data directory Define the paths to the training and testing dicom folders respectively Define paths to the relevant csv files Create the relevant dataframe objects Use the pydicom library to read the dicom file VOI LUT if available by DICOM device is used to transform raw DICOM data to human friendly view The XRAY may look inverted If we want to fix this we can Normalize the image array and return DEFAULTS Change the bar mode DEFAULT Initialize Color map stuff Update bbox dataframe to make this easier Aspect Ratio is Calculated as Width Height Generate the bar plot class TrainData def __init__ self df train_dir cmap Spectral self. This is an object detection and classification problem. Note that the linked document describes VOC 2012 which differs in some minor ways e. 2020 Nov 14 35 6 354 60. dicom image_id row 0 class_id int row 1 rad_id int row 2 1 if row 1 14 annotations row 0 1 bbox row 3 else annotations row 0 1 bbox row 3. From the heatmaps plotted below we can ascertain the following information TBDINVESTIGATE THE SIZES OF BOUNDING BOXES AND THE IMPACT OF CLASS From the boxplot plotted below we can ascertain the following information TBDINVESTIGATE THE ASPECT RATIO OF BOUNDING BOXES AND THE IMPACT OF CLASSWe want to understand the average shape wide narrow square etc. potential future improvement or option. groupby image_id. In this case I have created a class unwieldy as it may be currently in it s initial version to help with that called TrainData. get_annotations image_ids image_id_list annotated_imgs n len image_id_list plt. atypical 1 0 0 1 1 MESSAGE FROM THE COMPETITION HOST ON LABEL AND BBOX DETAILS In this challenge the chest radiographs CXRs were categorized using a specific grading schema based on a published paper Litmanovich DE Chung M Kirkbride RR Kicska G Kanne JP. append class_id new_rad_ids. get_annotated_image IMAGE_ID annots None plot True plot_size 18 22 plot_title f REDUX VERSION xa0IMG i 1. The images are in DICOM format which means they contain additional data that might be useful for visualizing and classifying. If you grab all the rows for a single id you will have all of the objects detected within that patients radiograph. train_dir train_dir self. dropna gt_df x_min gt_df bbox. To identify the distribution of counts across the labels we will use a bar chart. I will get into the details of how the methods work at a later time. pal tuple int x for x in np. loc x_min y_min x_max y_max. In cases of multiple adjacent opacities we opted for one large bounding box rather than multiple adjacent smaller boxes to improve consistency in the labeling. array c 255 255 255 for c in sns. COLOR_GRAY2RGB for ann in image_annots if ann class_id 14 img draw_bboxes img ann bbox 2 ann bbox 2 rgb self. 3 EXPLORATION OF BBOX COORDINATE COLUMNS The xmin ymin xmax and ymax columns indicate the location of the annotated object bounding box where the top left corner is represented by the tuple xmin ymin and the bottom right corner is represented by the tuple xmax ymax. In this competition we are making predictions at both a study multi image and image level. 1 THE DATA BACKGROUND INFORMATIONIn this competition we are identifying and localizing COVID 19 abnormalities on chest radiographs. ", "id": "dschettler8845/visual-in-depth-eda-siim-covid19-detection", "size": "20406", "language": "python", "html_url": "https://www.kaggle.com/code/dschettler8845/visual-in-depth-eda-siim-covid19-detection", "git_url": "https://www.kaggle.com/code/dschettler8845/visual-in-depth-eda-siim-covid19-detection", "script": "Counter plot_radiologists plotly.graph_objects tensorflow_addons calc_iou pandarallel plotly.express _get_inner_box kaggle_datasets get_annotated_image numpy Image seaborn redux_bboxes ListedColormap glob get_dicom_data get_annotations get_human_label matplotlib.patches KaggleDatasets tensorflow unpack_bbox_column plot_classes matplotlib.pyplot TrainData() get_absolute_file_paths PIL matplotlib.colors plot_image_ids pandas dicom2array draw_bboxes datetime tqdm.notebook tqdm; tqdm.pandas(); create_fractional_bbox_coordinates seed_it_all apply_voi_lut __init__ pandarallel; pandarallel.initialize(); collections pydicom.pixel_data_handlers.util ", "entities": "(('particular you', 'possible 4 categories'), 'categorize') (('currently it', 'initial that'), 'create') (('also detections', 'given patient image'), 'know') (('we', 'labeling'), 'opt') (('that', 'experienced radiologists'), 'negative') (('iloc index annotations', 'tmp_df'), 'image_id') (('PERCENTAGE', 'plots'), 'bound') (('opacities', 'study level still atypical label'), 'note') (('I', 'functionality'), 'generate') (('we', 'submission kernelDATA FILES train_study_level'), 'be') (('we', 'drawn lines'), 'use') (('lung grading system', 'chest radiographic findings'), 'have') (('plot_radiologists self def 4', 'annotations height_multiplier 6 True self'), 'show') (('annotations', 'train_df Dataframe'), 'ascertain') (('NUMBER', 'IMAGEWe'), 'know') (('radiologists', '19 patients'), 'help') (('i d column', 'duplicates'), 'be') (('0 1 opacities', '0'), 'indicate') (('show plot_classes self class_list n 4 height_multiplier', 'annotations 6 True self'), 'def') (('that', 'additional data'), 'be') (('annotations', 'heatmap'), 'identify') (('bar mode DEFAULT Initialize Color map Update bbox Aspect easier Ratio', 'bar plot class TrainData def _ _ init'), 'install') (('challenge', 'IoU'), 'mean') (('line_thickness', 'plot plot_image img title plot_title figsize plot_size return img plot_image_ids image_id_list annotations 4 def 6 True self'), '08') (('explanatory integer_label explanatory Self Integer', 'instead human readable'), 'INFORMATION') (('Bounding boxes', 'pleural effusions'), 'place') (('where their', 'values'), 'note') (('one', 'following arguments'), 'collect') (('annots', 'False 18 25 plot_title'), 'annotation') (('this', 'numbers'), 'let') (('d unique image identifier boxes', 'boxes1'), 'label') (('row respective object', 'patient'), '1') (('Only bounding boxes', 'specified classes'), 'NOTE') (('image ID', 'training dataset'), 'relate') (('all', 'patients'), 'have') (('goal', 'box bounding prediction'), 'be') (('who', 'typical appearances'), 'have') (('ANNOTATIONS', 'CLASSWe'), 'know') (('plot_classes class_list', 'False 7 2 train_data'), 'verbose') (('prediction', 'i.'), 'make') (('very when we', 'functionality'), 'parse') (('NOTE Images', 'classes'), 'contain') (('we', 'wide narrow square etc'), 'ascertain') (('that', 'additional data'), 'note') (('2012 which', 'minor ways'), 'note') (('append len', 'new_bboxes new_bboxes'), 'other_bbox') (('chest radiographs CXRs', 'published paper'), 'message') (('Bounding boxes', 'lobar consolidation nodules solitary masses'), 'place') (('else image_annots', 'img cv2'), 'copy') (('PLOT IMAGESSummary', 'laterPLOT IMAGES'), 'contain') (('probably TBD', 'LISTSummary'), 'contain') (('how methods', 'later time'), 'get') (('which', 'de patient privacy'), 'DATASET') (('you', '2 447 images'), 'train') (('Annotators', 'status'), 'have') (('only we', 'accordingly i.'), 'plan') (('row', 'one object annotation'), 'exploration') (('DATA BACKGROUND competition we', 'chest radiographs'), 'INFORMATIONIn') (('this', '1'), 'predict') (('we', 'study multi image level'), 'make') (('you', 'chest radiographs'), '2') (('we', 'bar chart'), 'use') (('you', 'findings'), 'predict') (('images', 'form study series image'), 'note') (('Atypical 0 otherwise 1 study', 'appearance'), 'csv') (('bottom right corner', 'tuple'), 'EXPLORATION') (('figure', 'enumerate annotations'), 'figsize') (('0 100 20 i', 'IMAGE_ID_LIST train_data'), 'enumerate') (('0 Summary', 'EACH BBOX 2 TBDATYPICAL'), 'visualize') (('lung opacitiesBounding boxes', 'lung opacities'), 'negative') (('which', 'four categories'), 'classify') (('bounding boxes', 'pneumonia category'), 'place') "}