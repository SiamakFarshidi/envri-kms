{"name": "prostate cancer detection end to end ml project ", "full_name": " h1 Introduction h1 Exploratory Data Analysis h1 Data h1 Data Labels h1 Data Pre Processing h1 Data Labelling h1 Training the Models h1 Conclusion ", "stargazers_count": 0, "forks_count": 0, "description": "A score of 1 would be a perfect performance grading every example with the same grade given by expert pathologists. Valid values 0 background non tissue or unknown 1 benign tissue stroma and epithelium combined 2 cancerous tissue stroma and epithelium combined We will label apply Karolinska s method of not distinguishing between stroma and epithelium. I had to settle for binary cross entropy which doesn t distinguish how far away mis classifications are from the true value whereas the final grading for this competition does. DataIt took a little time to get used to working with multi level tiff files. We see below for reference the first five rows of the CSV file provided alongside our images and masks. We see below that our data is split nearly 50 50 across our two data providers but that the examples provided by Radboud University Medical Center are more severe than those provided by the Karolinska institute. Data LabelsEach image in our training data comes with a corresponding mask tiff file of same size providing us with pixelwise labelling in the red channel other channels are set to zero. Validation accuracy got to roughly 0. Our EDA checked for mislabelled examples i. Multi level means the file contains the same image at three different resolutions corresponding to a downsampling of 1 4 and 16. I thoroughly enjoyed and appreciated the code and ideas that I learnt from and look forward to the next challenge. The NN would take 90 values and output a single ISUP grade. This was a deciding factor in my decision to split up the examples by data provider in the last step of grading. I conducted the same process with the masks to obtain 224x224 label images for each tile. Training the ModelsEach tile was copied to three folders according to whether each of the three possible patterns were present or not. com dararc panda step 1 tiling Data Labelling Up until now I had got by with an introduction from Andrew Ng s Machine Learning course plenty of python tutorials particularly several DataCamp courses learning from other entrants notebooks and many hours of trial and error. Machine Learning has already shown promise in this domain. I could make use of all the Karolinska data in this phase as I was now predicting with our RESNET50 models on the top 30 tiles per image the mask files were irrelevant for this step as all the labels I needed was the final ISUP grade of the whole slide. Access the intermediate layer of the Whole Slide Image multi level tiff file split it into 224x224 px tiles and select the 30 tiles with the most tissue. Iafoss great tiling technique http www. That is to say only tiles coming from images which were either purely benign only gleason 3 only gleason 4 or only gleason 5 were used as training data for the RESNET50 models. We see here an sample from the same image at each of the three resolutions starting with the lowest before zooming in twice 4x in each case on a particular section. Radboudumc Prostate glands are individually labelled. The Data 10 616 Whole Slide Images between 5 000 and 40 000 pixels in both width and height lots of empty space of prostate tissue format Multi level tiff file with accompanying Masks which contain pixelwise labels for each image. This was my first ML competition having started upskilling into the field in March. So I only used Karolinska slides which contained only one pattern. Techniques which proved fruitful for other entrants will be discussed as well as the principal avenues for improvement. These models would give us 3 figures per tiles so we still had to collate these 90 figures into a single ISUP grade. Key Karolinska Black Background Grey Healthy Tissue Purple Cancerous Radboud Black Background Grey Healthy Tissue Yellow Gleason 3 Orange Gleason 4 Red Gleason 5 Data Pre ProcessingThe training data above needed to be pre processed into a form that could train a model. com dararc eda on tile labels Karolinska data only labelled tissue as cancerous or benign. This way I used all the data to train each model to ascertain whether each pattern was present or absent in a given tile. It is worth mentioning here how the gleason score and the isup grade are calculated. Introduction The Task Design a system to grade Whole Slide Images of Prostate Tissue Biopsies. Exploratory Data AnalysisA detailed introduction to the challange and exploratory data analysis including python code can be found here. I hard coded some procedures which got a QWK score of 0. ConclusionThe system scored a QWK of 0. ISUP of 0 indicates no cancer while ISUP 5 is the most severe grading. The gleason score refers to which patterns are present 0 0 reflects no cancer present while a gleason score of 4 3 indicates gleason pattern four is the most prevalent cancer present while gleason three is also present. While a score of 0 is a performance no better than chance. I will certainly be gleaning as much as I can from the other entrant s work to improve my own system before taking the knowledge gained with me for other challenges. Valid values are 0 background non tissue or unknown 1 stroma connective tissue non epithelium tissue 2 healthy benign epithelium 3 cancerous epithelium Gleason 3 4 cancerous epithelium Gleason 4 5 cancerous epithelium Gleason 5 Karolinska Regions are labelled. The Radboud labels were semi automatically generated by several deep learning algorithms contain noise and can be considered weakly supervised while the Karolinska labels were semi automatically generated based on a pathologist s annotations. At this stage we had three models which could ascertain with about 70 accuracy whether each pattern was present in a tile. The winning entry scored 0. These 90 values split according to data provider are fed to one of two small Neural Networks which were trained on our data to output a final ISUP grade 0 1 2 3 4 or 5. Some really interesting ideas utilised by the top solutions included running predictions from several models and chosing the most common predicted value and accessing data from the highest resolution for uncertain regions. This gave me a grounding in flowing image data to Neural Networks using the Keras API. Detailed code similar to the final code used can be found here http www. As mentioned in the introduction I trained three seperate pre trained RESNET50 models to detect the three patterns of prostate cancer Gleason 3 Gleason 4 and Gleason 5. The Result Quadratic Weighted Kappa score of 0. 53 on the unseen test data. I repeated the process with cropping instead of padding to obtain twice as much data. e for reasons of mislabelling pen marks or missing masks. Links to the code will be provided and questions in the comments are welcome. I trained it on all the training data minus suspicious slides. I dropped any suspicious image ids from our training data i. I completed Introduction to TensorFlow for Artificial Intelligence Machine Learning and Deep Learning a four week course on the Coursera platform. For instance a tile containing gleason 3 and gleason 5 but not gleason 4. After about 25 epochs the model tended towards overfitting. This was done using three seperate notebooks as I ran up against the memory limits when running it all in one notebook. I tried to use the QWK as the loss function for this model but did not get this custom loss function finished in time Another task for the coming weeks. Each data provider labels the data slightly differently so with the help of a custom colour map we can display some images alongside their labels. 7 for these models training of one can be found here http www. 19 before realising that several thousand examples of 90 values which predict a single value was a perfect task for machine learning. There is definitely room for improvement in this step of the system and I will be experimenting by accessing different tiles for instance 16 tiles from the lowest layer as well as using augmentation of the training data. Radboud data provided us with labels as to whether Gleason 3 Gleason 4 or Gleason 5 was present in a particular region so for each of our training tiles I could read the corresponding mask file and determine whether each of the patterns was present in the tile. com dararc gl3 panda training. This system was designed as an entry to a 25 000 Kaggle competition hosted by the Karolinska Institute Medical University Sweden and the Radboud University Medical Center Netherlands. I decided that a cancerous region could obviously be present in the tile with the 25th most amount still some of tissue so I decided to run these models on the top 30 tiles when predicting. Two other points of note During the challenge it was revealed by the organisers that the Radboud data contained a significant level of noise. I made two small Neural Networks I am currently unsure if a Neural Network was the best choice for this task I will be researching this over the coming weeks one for each data provider. The output of each of these models are collected for each of the 30 tiles. set directory load data useful function for plotting counts useful function for plotting relative distributions creating a function to take an image id and return an array of the image or mask as required we set up two colour maps as described above this function will take 5 image ids and display an image and the related mask. com dararc introduction eda For the sake of brevity within this notebook I present a small snapshot of the analysis I conducted. This will take a lot of GPU hours so it will probably be late August before these improvements are live. The motivation Within Cancer grade assessment there can be significant inter observer variability and the time of expert pathologists is a valuable limited resource. 1 is perfect 0 is no better than chance Designing the System The rest of this notebook will describe at a relatively high level each step of designing and training this system. I experiemented with some resizing methods and edge detection using convolutions but having seen the success of the tiling technique I decided to utilise it with an adjustment to obtain twice as much data. Was copied to the three folders Gleason 3 present Gleason 4 absent Gleason 5 present. The tiles were saved as png files and my code for the process padding version cropping version differs only in two lines can be found here http www. The ISUP grade follows directly from the given Gleason score it is essentially a tidier scale to reflect the Gleason Score. I then accessed the intermediate layer of the data and padded it to so that both dimensions were multiples of 224 I then selected the 24 224x224 px boxes with the most tissue. com iafoss panda 16x128x128 tiles which he made public early on in the challenge was utilised by a lot of contenders. Our csv file contains the image id with which we can access the multi level tiff file the data provider the ISUP grade and the underlying gleason patterns. isup grades which did not match the underlying gleason patterns one mislabelled example was identified and removed. Each of the selected tiles is fed to three distinct binary classifiers. These binary classifiers consist of a RESNET50 model pretrained on ImageNet and trained on our Data to detect one of three possible Gleason patterns of prostate cancer. ", "id": "dararc/prostate-cancer-detection-end-to-end-ml-project", "size": "11329", "language": "python", "html_url": "https://www.kaggle.com/code/dararc/prostate-cancer-detection-end-to-end-ml-project", "git_url": "https://www.kaggle.com/code/dararc/prostate-cancer-detection-end-to-end-ml-project", "script": "plot_relative_distribution seaborn matplotlib.image tiles2pred matplotlib.pyplot plot_count tensorflow.keras.models id2array id2tiles pandas plot5 load_model numpy ", "entities": "(('examples', 'Karolinska institute'), 'see') (('score', 'expert pathologists'), 'be') (('Karolinska data', 'only tissue'), 'com') (('rest', 'system'), 'be') (('one mislabelled example', 'gleason underlying patterns'), 'grade') (('which', 'ISUP final grade'), 'feed') (('Access', 'most tissue'), 'split') (('This', 'Keras API'), 'give') (('I', 'one notebook'), 'do') (('I', 'data one provider'), 'make') (('This', 'grading'), 'be') (('other channels', 'zero'), 'come') (('score', 'better chance'), 'be') (('probably late improvements', 'GPU hours'), 'take') (('questions', 'comments'), 'provide') (('so I', 'top 30 tiles'), 'decide') (('I', 'twice as much data'), 'experiemente') (('motivation', 'inter observer expert significant pathologists'), 'be') (('certainly as much I', 'other challenges'), 'glean') (('model', 'overfitting'), 'after') (('so we', 'ISUP single grade'), 'give') (('I', 'most tissue'), 'access') (('Each', 'three distinct binary classifiers'), 'feed') (('Detailed code', 'here www'), 'find') (('I', 'prostate cancer Gleason'), 'train') (('pattern', 'tile'), 'have') (('cancer gleason most prevalent three', '4'), 'refer') (('each', 'three possible patterns'), 'copy') (('I', 'many trial'), 'step') (('DataIt', 'level tiff multi files'), 'take') (('I', 'minus suspicious slides'), 'train') (('I', 'Coursera platform'), 'complete') (('NN', 'ISUP single grade'), 'take') (('output', '30 tiles'), 'collect') (('I', 'tile'), 'conduct') (('Karolinska weakly labels', 'automatically pathologist annotations'), 'generate') (('ISUP', 'cancer'), 'indicate') (('tissue tissue Valid values 0 background non unknown 1 benign epithelium combined 2 cancerous We', 'stroma'), 'tissue') (('EDA', 'examples mislabelled i.'), 'check') (('Machine Learning', 'domain'), 'show') (('process', 'here www'), 'save') (('which', 'machine perfect learning'), '19') (('We', 'particular section'), 'see') (('each', 'tile'), 'provide') (('really interesting ideas', 'uncertain regions'), 'include') (('which', 'image'), 'image') (('I', 'ISUP final whole slide'), 'make') (('which', 'as well principal improvement'), 'discuss') (('3 only 4 gleason', 'RESNET50 models'), 'be') (('we', 'labels'), 'label') (('that', 'model'), 'Healthy') (('he', 'contenders'), 'utilise') (('custom loss function', 'coming weeks'), 'try') (('I', 'training data'), 'be') (('level tiff multi data', 'ISUP grade'), 'contain') (('3 Karolinska 2 healthy benign epithelium 3 cancerous epithelium 4 cancerous 4 5 cancerous Gleason 5 Regions', 'stroma 0 background non unknown 1 connective non epithelium tissue'), 'be') (('we', 'image'), 'take') (('final grading', 'competition'), 'have') (('which', 'only one pattern'), 'use') (('I', 'training data'), 'drop') (('introduction', 'python code'), 'detail') (('binary classifiers', 'prostate cancer'), 'consist') (('first five rows', 'images'), 'see') (('I', 'instead twice as much data'), 'repeat') (('it', 'Gleason essentially tidier Score'), 'follow') (('This', 'March'), 'be') (('I', 'analysis'), 'com') (('which', '0'), 'code') (('Radboud data', 'noise'), 'reveal') (('system', 'Karolinska Institute Medical University Sweden'), 'design') (('I', 'forward next challenge'), 'enjoy') (('file', '1 4'), 'mean') (('models training', 'here www'), 'find') (('pattern', 'given tile'), 'use') "}