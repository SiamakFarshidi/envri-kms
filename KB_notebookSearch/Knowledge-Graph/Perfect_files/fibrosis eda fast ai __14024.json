{"name": "fibrosis eda fast ai ", "full_name": " h1 Pulmonary Fibrosis EDA h2 Another image competition goes by and this is rather interesting I will be interested to see how well people can create their own solutions or apply solutions from Pneumothorax Segmentation competition or if you really want to go down memory lane perhaps Data Science Bowl 2017 h2 What to expect in this kernel h2 Changelogs h1 Domain Knowledge h1 Train files h1 Train CSV exploration h1 Fast ai yay 3 h1 Preprocessing credits to Guido Zuidhof h1 Afterword a better preprocessing h2 Proposed aug Roman s hair augs h1 Building a baseline model h4 Explanation of model architecture h1 Metric learning h1 Todo h2 Thank you to Jeremy Howard ", "stargazers_count": 0, "forks_count": 0, "description": "Train CSV explorationLet s look at the CSV metadata now. We can invert the colors by adding a before it. com carlossouza end to end model ct scans tabular for the data preprocessing and generation part. PNG Source Wikipedia This is a prime example of a lung affected with pulmonary fibrosis. It fixes up our files for a neat data loader in case we ever want to use it in our modeling pipelines. 13 Pulmonary fibrosis is perpetuated by aberrant wound healing rather than chronic inflammation. Proposed aug Roman s hair augs Building a baseline modelHere are some objectives of our baseline model that we will add to it Some basic transforms We can use some simple torchvision transforms w our model such as ToTensor and torchvision normalization. I will be interested to see how well people can create their own solutions or apply solutions from Pneumothorax Segmentation competition or if you really want to go down memory lane perhaps Data Science Bowl 2017. org wikipedia commons thumb d d0 Medical_X Ray_imaging_WFH07_nevit. The turbo colormap which I have copy pasted at the top of this notebook is shockingly bright but it exposes the amount of empty space that we have in the image. Now here are the transforms random sized crop random flipping convert to tensor and normalization. ai demo Simple image feats EDA Image based EDAand more to come. This thresholds the image adds the connected components and within the filled segmented lungs attempts to create some bronchiole like structure. How about the duration HMMMMM. Normally adding a Gaussian blur would be much more difficult if not for fast. This lung image looks very similar to the Data Science Bowl 2017 and it also looks like we have quite a bit of metadata coming with each DICOM file. Pulmonary Fibrosis EDAAnother image competition goes by and this is rather interesting. This crops out the above neatly to leave just the lungs remaining right where we want them. com jhoward don t see like a radiologist fastai and we can easily view the details of the lungs with systematic windowing. com jhoward cleaning the data for rapid prototyping fastai. The second problem however is to see how we can improve on Roman s work. com c siim isic melanoma classification discussion 159476. Now we can isolate the lungs from the empty space. As we can see here we have a lot of patients subdirectories with 100 counts being the norm for most of the patients. There s a huge difference between male and female over here in that the majority of males affected are former smokers and the majority of females affected have never smoked. Now we re going to define a Model class so that we re able to train this CNN based model on our input images. Wikipedia describes it as HRCT of lung showing extensive fibrosis possibly from usual interstitial pneumonitis. We can work with something called systematic windowing which was previously used by radiologists with regards to the brain see the excellent notebook by Jemery Howard here https www. Could there be any underlying factor Train filesWith DICOM files we can retrieve the information as a numpy array with the DICOM attribute ds. We can try a gaussian blur to smooth out the bad parts here. glob for the train and test set. PNG 310px Pulmon_fibrosis. The majority of people here are ex smokers approximately a third of people and as such we can explore further based on gender i. jpg So the bulla is a noise all over the lungs. Trying to decipher this I was able to gather that this emphysematous bulla is always an indicator of pulmonary fibrosis. It s as effective a disease as it is due to the fact the wound healing is random and it s aberrant. It seems like this method is a dead end for now. com twinkle0705 your starter notebook for osic we have the circular nonexistent border discrepancy. ly of course I am bored of Seaborn p. Now let s examine a couple of images at a glance All the images look fairly uniform how about taking into account randomness So some images are uniform but others are not. This will help our model to potentially generalize well what with the diversity we re adding to our trianing data and what not. However we must be careful with loss of information as not even a robot would be willing to waste its valuable time examining miniscule patches on digital DICOM images. percentage of each per male and female. ai and the magic of its medical imaging module. Now however I won t write in detail about most of the common conventions there are forum posts on the subject but rather I ll write about what you should look for in your images that can provide an indicator. Thank you to Jeremy Howard. and now to shamelessly use an idea from Jeremy again and select the areas bright enough in the picture segment it Now create a simple mask for our image which albeit looks weird without the main image will serve certain purposes for us when it comes to modeling. As we have seen it is possible to toy with DICOM files. com ratthachat aptos eye preprocessing in diabetic retinopathyNow here we can use both Ben Graham s and Roman s techniques in conjunction with each other by performing the microscope augmentation technique and then adding a gaussian blur from Ben s work. A warning is due it is shockingly bright. The pointwise convolution does away wit the groups and then processes the depthwise convolution to return an output. Let s check the difference to see whether this method is actually feasible. Here s a more detailed lung with this bulla https upload. All this does is reduce the image to a smaller one without the unnecessary area at the bottom of the image. How about the target distribution in the data FVC So as of now let s take a look at smoking status of each affected person i. However now we can convert a DICOM to a data frmae. In layman s terms it s the ability of a certain kind of material to prevent radio waves or X rays to pass through them. There is also a large emphysematous bulla. However I decided to use his preprocessed CT Scans in conjunction with his data loader for demo purposes. Afterword a better preprocessing So yes we do need to preprocess a load of images considering the discrepancies between most of our train images especially with regards to the border which is either circular or nonexistent in most cases. jpg 120px Medical_X Ray_imaging_WFH07_nevit. This gets the Hounsfield Units a measurement to which the CT scanners are delicately calibrated to and Guido calls it a measure of radiodensitySo for those of you unenlightened on the subject of radiodensity I looked it up quickly and to quote Wikipedia Radiodensity or radiopacity is opacity to the radio wave and X ray portion of the electromagnetic spectrum that is the relative inability of those kinds of electromagnetic radiation to pass through a particular material. What we can do is visualize the DICOM files with a simple glob. Explanation of model architectureFirst of all I already said that depthwise pointwise convolutions will be the main event in our model so as such allow me to present to you the formula for a simple convolution out N_i C_ out_j bias C_ out_j sum_ k 0 C_ in 1 weight C_ out_j k star input N_i k Now a depthwise convolution takes the groups parameter and it declares the output shape as the input shape multiplied by kernels per layer and defines it as the same as the input shape. ai it becomes a lot easier for us to try and handle the data. Now we can view the distributions of image statistics one by one Not such a comfortable distribution to be working with. However once again I learnt never to take an assumption for granted by reading through even more Misdiagnosis is common because while overall pulmonary fibrosis is not rare each individual type of pulmonary fibrosis is uncommon and the evaluation of patients with these diseases is complex and requires a multidisciplinary approach. This is the Wikipedia description for the formation of the scar tissue that the scarring causes Pulmonary fibrosis involves gradual exchange of normal lung parenchyma with fibrotic tissue. pixel_array from the file which is relatively simple to use. The above basically just fixes up the pixel representation attribute of the DICOM file for us to use. He s using Ben Graham s technique which won a first place in the diabetic retinopathy competition and if you want to look deeper in the preprocessing methods refer to the following link https www. So again we can treat this with Roman s microscope augmentation as in the SIIM ISIC competition the same thing existed. 14 Here are some key points Normal lung becoming scar tissue stifles oxygen diffusion. The replacement of normal lung with scar tissue causes irreversible decrease in oxygen diffusion capacity and the resulting stiffness or decreased compliance makes pulmonary fibrosis a restrictive lung disease. org wikipedia commons thumb 8 81 Pulmon_fibrosis. And toy with the data again Now that it is possible for us to visualize the distribution it s actually possible for us to view it as a correlation matrix with Plot. What to expect in this kernel Fast. ai yay 3 Now with Fast. com gzuidhof full preprocessing tutorial and I ve tried to add clarity wherevr possible to whatever Guido has done here. This also belongs to Jeremy Howard https www. Now to move on to preprocessing. Preprocessing credits to Guido Zuidhof The functions and 3d plotting are from Guido s notebook https www. Now we can turn to the methods of Neuron Engineer whose preprocessing methods have been enumerated on many times previously by other notebooks including mine on SIIM ISIC. So it seems like we have a rather lackadaisical distribution of Age in the data which is interesting to consider. This function however has a rather unique purpose which is to display our DICOM files but with a twist it first displays the normal image and then it displays our windowed image scroll up to check what is windowing or go to the RSNA comp and look at a couple of notebooks. The background ought to be black instead of a weird psychedelic Neon Genesis Evangelion style but it works well. Changelogs Versions 1 6 Added structural baseline with fastai Versions 7 13 Messed with Turbo cmap Versions 14 47 Messed with DICOM viz and turbo cmap Versions 47 decided to add some more augs added the hair augs for future reference added and removed a Plotly lung visualization Version 51 Added these changelogs Version 52 Domain knowledge Domain Knowledge Pulmonary fibrosis is basically the scarring of the lungs to keep it as simple as possible. It is remarkable that we can extract this information from a DICOM. So with these multiple types of pulmonary fibrosis it would be difficult to accurately find some underlying factors from the provided data that can easily summarize pulmonary fibrosis from a CT scan. Here we can see the distinctions. This is a very naive form of preprocessing as it primarily only segments a part of the lungs and leaves the rest up for grabs. Depthwise convolutions would be better suited for TensorFlow rather than PyTorch because of the way they are optimized in PyTorch rather than TF however I m solely writing this in PyTorch for learning purposes. However checking the filling in the lungs could perhaps serve us better. Now that you have got over your eyes going kaboom let us proceed to a more shall I say medical view of things with the courtesy of fast. As you can see in the following image from the notebook Your Starter Notebook for OSIC https www. So that takes care of our first problem. We also have a few patients breaching the 200s and making their way to the 400s or 500s. e whether the person is a former smoker whether the person never smoked or whether the person currently smokes for perspective. Well windowing works particularly well for computers because us humans require a lot more than simple black white and grey so we can try some sort of better windowing in a rainbow colormap. So this is the complete merger of both Roman s and Ben s augmentations you can use this slightly blurred image for your modeling purposes and since it s been microscoped it would work pretty nicely. This basically reads in a DICOM file fixes up its pixel representation attribute as I have displayed earlier with the previous one and it then returns a Tensor image. So what this does is basically get the dicom files sort the files and get slice thickness and make it a file property or modify the SliceThickness attribute if the attribute exists. Now however we have normalized the images and found a pretty good colormap to use. I initially wanted to use Carlos Souza s excellent End to end model notebook s data generator https www. The above is basically just our earlier image in Tensor format for a neural network to utilize. Beautiful Now we can attempt to segment the lungs. Simple CNN based model This will be using a simple convolutional neural network based model w the assistance of PyTorch and I will also attempt clumsily to demonstrate each layer in detail using the torchsummary package. We also can visualize convolution filters This is now our fully preprocessed image in full 3d glory. Metric learning Todo start training more detailed EDA on image featuresAgain cheerio for now I ll be back with more fastai for you later. We might need to even this out so in that case I ll be taking the aid of Roman s microscope augmentation again another idea from SIIM ISIC competition over here https www. Rather odd distribution over here too. ", "id": "nxrprime/fibrosis-eda-fast-ai", "size": "14024", "language": "python", "html_url": "https://www.kaggle.com/code/nxrprime/fibrosis-eda-fast-ai", "git_url": "https://www.kaggle.com/code/nxrprime/fibrosis-eda-fast-ai", "script": "torch.nn.functional FileDataset dicom_to_image plot_3d mean __call__ pathlib fastai2.basics Poly3DCollection distrib_summ pyplot plotly.express pyplot as plt segment_lung_mask dcm_tfm show_dcm_info numpy lllloss seaborn skimage pad_square mpl_toolkits.mplot3d.art3d Path pydicom Microscope torch.nn plotly.io RGBToPyCmap plotly.tools CTTensorsDataset(torch.utils.data.Dataset) conv matplotlib.pyplot pydicom.dataset FileMetaDataset MetricOptimizer forward plotly.offline plotly.graph_objs pandas depthwise_separable_conv(nn.Module) largest_label_volume load_scan Model(nn.Module) fix_pxrepr morphology fit matplotlib __len__ Dataset fastai2.medical.imaging __init__ AdvancedHairAugmentation crop_mask get_pixels_hu random_split measure __getitem__ ", "entities": "(('when it', 'us'), 'use') (('neural network', 'Tensor basically just earlier format'), 'be') (('we', 'image'), 'be') (('We', 'it'), 'invert') (('So bulla', 'all lungs'), 'jpg') (('this', 'image'), 'reduce') (('which', 'file'), 'pixel_array') (('it', 'DICOM files'), 'be') (('functions', 'notebook https www'), 'preprocessing') (('Here more detailed lung', 'bulla https upload'), 's') (('100 counts', 'patients'), 'have') (('we', 'modeling pipelines'), 'fix') (('you', 'link https following www'), 'use') (('Train CSV explorationLet', 'CSV metadata'), 'look') (('Normally adding', 'Gaussian blur'), 'be') (('I', 'model data generator https www'), 'want') (('we', 'systematic windowing'), 'see') (('we', 'input images'), 'go') (('resulting decreased pulmonary fibrosis', 'lung restrictive disease'), 'cause') (('rather however I', 'purposes'), 'suit') (('I', 'courtesy'), 'let') (('we', 'DICOM'), 'be') (('very naive it', 'grabs'), 'be') (('Wikipedia', 'possibly usual interstitial pneumonitis'), 'describe') (('we', 'border circular nonexistent discrepancy'), 'twinkle0705') (('Pulmonary 13 fibrosis', 'rather chronic inflammation'), 'perpetuate') (('systematic which', 'https here www'), 'work') (('it', 'fact'), 's') (('lot us', 'data'), 'ai') (('others', 'account fairly how randomness'), 'let') (('method', 'difference'), 'let') (('we', 'rainbow of better colormap'), 'work') (('image', 'structure'), 'threshold') (('based EDAand', 'image feats EDA Simple Image'), 'demo') (('you', 'memory really lane'), 'be') (('that', 'indicator'), 'be') (('Domain knowledge Domain Knowledge Pulmonary Version 52 fibrosis', 'it'), 'version') (('however how we', 'work'), 'be') (('Now however we', 'pretty good colormap'), 'normalize') (('bit', 'DICOM file'), 'look') (('now I', 'you'), 'learn') (('Here key Normal lung', 'scar oxygen diffusion'), '14') (('However checking', 'perhaps us'), 'serve') (('preprocessing methods', 'SIIM ISIC'), 'turn') (('attribute', 'file SliceThickness attribute'), 'get') (('Beautiful Now we', 'lungs'), 'attempt') (('it', 'Tensor then image'), 'read') (('which', 'most cases'), 'preprocessing') (('it', 'modeling purposes'), 'be') (('DICOM underlying factor filesWith we', 'DICOM attribute ds'), 'be') (('even robot', 'DICOM digital images'), 'be') (('it', 'X them'), 's') (('right where we', 'them'), 'crop') (('Now we', 'empty space'), 'isolate') (('However I', 'demo purposes'), 'decide') (('which', 'data'), 'seem') (('you', 'Starter OSIC https www'), 'see') (('evaluation', 'multidisciplinary approach'), 'learn') (('here we', 'work'), 'eye') (('what', 'notebooks'), 'have') (('PNG Source This', 'pulmonary fibrosis'), 'Wikipedia') (('We', 'torchvision such ToTensor normalization'), 'aug') (('data', 'end model'), 'end') (('Now we', 'one one'), 'view') (('that', 'CT scan'), 'be') (('However now we', 'data frmae'), 'convert') (('I', 'https www'), 'need') (('that', 'particular material'), 'get') (('as such we', 'gender further i.'), 'be') (('So now s', 'person affected i.'), 'about') (('This', '3d now fully preprocessed full glory'), 'visualize') (('pointwise convolution', 'output'), 'do') (('com jhoward', 'prototyping rapid fastai'), 'clean') (('Guido', 'possible whatever'), 'preprocessing') (('we', 'trianing data'), 'help') (('This', 'Jeremy Howard https also www'), 'belong') (('over here majority', 'former females'), 'smoke') (('actually us', 'Plot'), 'toy') (('emphysematous bulla', 'always pulmonary fibrosis'), 'be') (('person', 'currently perspective'), 'e') (('We', '400s'), 'have') (('We', 'bad parts'), 'try') (('do', 'simple glob'), 'be') (('it', 'input shape'), 'Explanation') (('Pulmonary fibrosis', 'fibrotic tissue'), 'be') (('same thing', 'SIIM ISIC competition'), 'exist') (('flipping Now here transforms random sized crop random convert', 'tensor'), 'be') (('I', 'torchsummary package'), 'model') (('us', 'DICOM file'), 'fix') "}