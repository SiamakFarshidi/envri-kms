{"name": "4 th place solution inference and training tips ", "full_name": " h1 Import additional packages h1 Import packages h1 Main Config Variables h1 Audio Preprocessing h2 Utils h2 Main Pipeline h2 Torch Dataset h1 Load Dataframe h1 Initialize Dataset h1 torchaudio utils h1 Resnext initialize functions h1 BIG BIG Model class h2 Model utils h1 ALL My Models h1 Predict Loop h1 Create final submission DF h1 Train Tips h2 Augmentations h3 Gain h3 Background Noise h3 LowFrequency CutOff h3 All Pipeline h2 Mixup h2 Multi Sample Dropout h2 Energy trimming ", "stargazers_count": 0, "forks_count": 0, "description": "5 effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_0 Public score 0. com zhanghang1989 ResNeSt Sample rate of audio Whether to normalize audio by max np. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_swa_f1_test_median_fold_0. noises au au 1 alpha noise alpha return au LowFrequency CutOff pythonclass LowFrequencyMask audiomentations. power wave 2 def compute_sampling_distribution feature np. BasicTransform def __init__ self noise_folder_path str p int 0. input cornell birds models effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_2. 5 allways_apply bool False max_cutoff float 5 min_cutoff float 4 super. Linear nn_embed_size hidden_dims nn. BasicTransform def __init__ self p int 0. allways_apply allways_apply self. 0 super. com iver56 audiomentations pythonclass Gain audiomentations. Warning This transform can return samples outside the 1 1 range which may lead to clipping or wrap distortion depending on what you do with the audio in a later stage. 75 Mixup I have used OR Mixup that was proposed by Dmytro Danevskyi https www. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto Public score 0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_swa_f1_test_median_fold_3. pt DEVICE effnet4_multiscalereluclas_plato_deltas_32bs_2acum_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugsless_newbacks_secondarylabels_mixupsumwave05_xeno_canto Public score not commited Is not used in best Blend initalize_spectral_model NEW_EFFNET4_MD. allways_apply alpha np. See also https en. 1 audiomentations. com rwightman gen efficientnet pytorch https github. input cornell birds models effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_1. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10_swa_f1_test_median_fold_2. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10_swa_f1_test_median_fold_3. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01_swa_f1_test_median_fold_2. parameters amplitude_ratio Background Noise pythonclass SpecifiedNoise audiomentations. com iver56 audiomentations GainTaken from https github. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_ls005 Public score 0. input cornell birds models effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_1. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_swa_f1_test_median_fold_1. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01_swa_f1_test_median_fold_4. 75 LowFrequencyMask min_cutoff 5 max_cutoff 7 p 0. We get new filename 2. 001 max_snr_in_db 2 p 0. input cornell birds models effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_4. max_gain_in_db def apply self samples sample_rate return samples self. abs Minimum length of audio to predict Computational device Inference batch size Thresholding value Maximum amount of birds in raw. ndarray hop_size int window_size int probs_comp str softmax n_steps max math. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01 Public score 0. big_dropout x for _ in range 5 dim 0 dim 0 Energy trimmingI have created RMS feature with window size of 5 seconds and step size of 1 second. input cornell birds models effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_2. parameters should_apply self. 5 effnet4_reluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto Public score 0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_swa_f1_test_median_fold_4. We just started and we do not have loaded audio Get duration num of seconds Do not process audio less then one sec Padd if we do not have 5 secs in segment dataset created by shonenkov thanks pack batch twice sum of integer squared unpack batch By default use the entire frame Set the default hop if it s not already specified Pad the window out to n_fft size DFT IDFT matrix n_fft 2 1 1 n_fft n_fft 2 1 1 n_fft batch_size channels_num data_length batch_size n_fft 2 1 time_steps batch_size 1 time_steps n_fft 2 1 batch_size n_fft 2 1 time_steps n_fft 2 1 mel_bins Mel spectrogram Logmel spectrogram dim 2 time dim 3 frequency Average over frequency bins. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10_swa_f1_test_median_fold_1. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_swa_f1_test_median_fold_1. Then normalized it in order to use as probability distribution for sampling start second of the audio pythondef compute_normalized_energy wave np. load noise_path sr None 0 for noise_path in filenames self. low_alpha low_alpha self. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01_swa_f1_test_median_fold_1. pdf and used by winners of QA competition https www. Linear hidden_dims hidden_dims nn. array wave wave np. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10_swa_f1_test_median_fold_4. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_swa_f1_test_median_fold_4. 4 Is not used in best Blend initalize_spectral_model NEW_EFFNET4_MD. Dropout p first_dropout_rate nn. __init__ p assert min_gain_in_db max_gain_in_db self. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01_swa_f1_test_median_fold_0. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05 Public score 0. max_gain_in_db max_gain_in_db def randomize_parameters self samples sample_rate super. input cornell birds models effnet4_multiscalereluclas_plato_deltas_32bs_2acum_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugsless_newbacks_secondarylabels_mixupsumwave05_xeno_canto_swa_f1_test_median_fold_0. 5 else raise ValueError Invalid probs_comp return probsh_s sr 1w_s sr 5t_pobs compute_sampling_distribution feature compute_normalized_energy au hop_size h_s window_size w_s probs_comp uniform start np. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto_swa_f1_test_median_fold_2. pt DEVICE initalize_spectral_model NEW_EFFNET3. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_swa_f1_test_median_fold_0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01_swa_f1_test_median_fold_3. high_alpha noise self. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_swa_f1_test_median_fold_3. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01_swa_f1_test_median_fold_3. min_cutoff high self. max_cutoff au butter_lowpass_filter au cutoff cutoff_value fs sr 1000 return au All Pipeline noisy_samples you can find in this dataset https www. pt DEVICE effnet5_multiscalereluclas_plato_deltas_32bs_2acum_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto Public score 0. Each model is created by SWA simple averaging of weight matrices from 3 best chekpoints taken for f1_test_median Predict Loop Create final submission DF Train Tips AugmentationsGreat thanks for audiomentations package https github. randomize_parameters samples sample_rate if self. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01_swa_f1_test_median_fold_4. min_gain_in_db min_gain_in_db self. min_cutoff min_cutoff def apply self au sr if np. __init__ p filenames glob pjoin noise_folder_path. 5 effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075 Public score 0. input cornell birds models effnet4_multiscalereluclas_plato_deltas_32bs_2acum_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugsless_newbacks_secondarylabels_mixupsumwave05_xeno_canto_swa_f1_test_median_fold_4. If None no limit Bird code dict Extract data from dataframe We have to load new audio if only 1. This technique can help a model become somewhat invariant to the overall gain of the input audio. input cornell birds models effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_4. com ddanevskyi here https www. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01_swa_f1_test_median_fold_1. com ex4sperans freesound classification Classifier type Augmentations Final activation Additional features Some additional stuff batch_size 1 time_steps freq_bins batch_size 1 time_steps mel_bins Output shape batch size channels time frequency Output shape batch size channels effnet3_multiscalereluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto Public score 0. pt DEVICE If we have site3 we get list of samples If we have site1 or site2 only one sample If site3 produced very big batch we decompose it in smaller ones Or models are blend with simple Mean Or models are blend with simple Mean Concatanate batches Create DataFrame Aggregate predictions from site3 by Max Handle output for clipwise framewise model. 5 effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls01 Public score 0. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_ls005 Public score 0. high_alpha high_alpha def apply self au sr if np. input cornell birds models effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto_swa_f1_test_median_fold_0. max_cutoff max_cutoff self. ceil len feature window_size hop_size 1 if probs_comp softmax areas feature hop_size i window_size hop_size i. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_swa_f1_test_median_fold_2. But Label Smoothing did not work for me in all cases Multi Sample DropoutOriginally proposed in this paper https arxiv. 5 param p super. 5 allways_apply bool False low_alpha float 0. pt DEVICE effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels Public score 0. parameters amplitude_ratio convert_decibels_to_amplitude_ratio random. sum for i in range n_steps probs softmax areas elif probs_comp uniform areas feature hop_size i window_size hop_size i. 5 effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto Public score 0. input cornell birds models effnet4_multiscalereluclas_plato_deltas_32bs_2acum_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugsless_newbacks_secondarylabels_mixupsumwave05_xeno_canto_swa_f1_test_median_fold_2. allways_apply cutoff_value np. com c freesound audio tagging 2019 discussion 97926 I have used high mixup probability 75 Here is full loss function which includes Mixup and Label Smoothing. AddBackgroundNoise ssd_data birdsong_recognition noisy_samples min_snr_in_db 0. pt DEVICE initalize_spectral_model NEW_EFFNET3_MD_TFE. 5 effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10 Public score 0. sum for i in range n_steps probs np. BasicTransform Multiply the audio by a random amplitude factor to reduce or increase the volume. randint low 0 high len self. mean for i in range n_steps probs softmax np. 0 high_alpha float 1. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto_swa_f1_test_median_fold_4. org wiki Clipping_ audio Digital_clipping def __init__ self min_gain_in_db 12 max_gain_in_db 12 p 0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01_swa_f1_test_median_fold_0. Compose Gain p 0. __init__ p self. array areas sum areas elif probs_comp rm_softmax areas feature hop_size i window_size hop_size i. Linear hidden_dims classes_num logits torch. 5 effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto Public score 0. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_ls01_swa_f1_test_median_fold_2. com vladimirsydor cornelli background noises pythonaudiomentations. Import additional packages Import packages Main Config Variables Audio Preprocessing Utils Main Pipeline Torch Dataset Load Dataframe Initialize Dataset torchaudio utils Resnext initialize functions BIG BIG Model class Model utils ALL My ModelsAll models are taken from 5 folds so each experiment contains bunch of 5 models. com c google quest challenge overview pythonself. Dropout p second_dropout_rate nn. input cornell birds models effnet3_multiscalereluclas_plato_timefreqencode_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_3. pt DEVICE initalize_spectral_model NEW_EFFNET4_MD. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto_swa_f1_test_median_fold_3. 5 Is not used in best Blend initalize_spectral_model NEW_EFFNET3_MD_TFE. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_nocalldatax10_swa_f1_test_median_fold_0. input cornell birds models effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_0. 5 Is not used in best Blend initalize_spectral_model NEW_EFFNET3. choice len t_pobs size 1 p t_pobs 0 segment au start h_s start h_s w_s https github. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave05_swa_f1_test_median_fold_2. normalize noise for noise in self. Spectral Config Start Spectral Config End Model Config Start Model Config End Feature Extraction Config Start Feature Extraction Config End Other Config Start Other Config End Downsampled ratio Spectrogram extractor Logmel feature extractor Spec augmenter inspired by https github. input cornell birds models effnet3_reluclas_plato_deltas_64bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_extxenocanto_swa_f1_test_median_fold_1. input cornell birds models effnet4_multiscalereluclas_plato_deltas_50bs_001lr_biggerfft_trackmap_energytrimming_topdb80_firstaugs_secondarylabels_mixupsumwave075_xeno_canto_swa_f1_test_median_fold_3. 5 SpecifiedNoise ssd_data birdsong_recognition noisy_samples low_alpha 0. ", "id": "vladimirsydor/4-th-place-solution-inference-and-training-tips", "size": "6603", "language": "python", "html_url": "https://www.kaggle.com/code/vladimirsydor/4-th-place-solution-inference-and-training-tips", "git_url": "https://www.kaggle.com/code/vladimirsydor/4-th-place-solution-inference-and-training-tips", "script": "resnest50_fast_1s1x64d __init__ glob STFT(DFTBase) idft_matrix load_chkp List dft_matrix resnext50_32x4d_swsl PreprocessWaveform(object) make_delta Optional torchvision.models.resnet InfernceDataPipelineFileName2Au(object) Any StrongBCEwithLogitsMixUp(nn.Module) Path preprocess join as pjoin forward torch.nn _add_time_encoding _sum_mixup numpy _add_frequency_encoding __getitem__ os.path pathlib _resnext compute_deltas LogmelFilterBank(nn.Module) transform_slice Spectrogram(nn.Module) typing SpecAugmentation(nn.Module) Tuple join Test2StepDataset(torch.utils.data.Dataset) ResNet tqdm.notebook pandas Union SpectralEffnet(nn.Module) Bottleneck __len__ power_to_db DropStripes(nn.Module) tqdm DFTBase(nn.Module) probs2names torch.nn.functional ReadAudio(object) Loudness(nn.Module) initalize_spectral_model resnest.torch resnext101_32x4d_swsl Mapping __call__ ", "entities": "(('i', 'hop_size i.'), 'hop_size') (('that', 'Dmytro Danevskyi https www'), 'Mixup') (('choice len t_pobs size p t_pobs 0 segment', 'https h_s start github'), 'start') (('randomize_parameters', 'sample_rate'), 'sample') (('i', 'hop_size i.'), 'probs_comp') (('butter_lowpass_filter au cutoff fs Pipeline 1000 you', 'https dataset www'), 'au') (('audiomentations iver56 pythonclass', 'audiomentations'), 'com') (('1 time_steps freq_bins', 'mel_bins shape batch size channels time frequency Output shape batch size 1 time_steps channels'), 'feature') (('com vladimirsydor cornelli background', 'pythonaudiomentations'), 'noise') (('_ _ init _ _ p filenames', 'pjoin noise_folder_path'), 'glob') (('i', 'hop_size i.'), 'sum') (('max_gain_in_db def', 'self samples sample_rate return samples self'), 'apply') (('DFT IDFT batch_size data_length 2 2 2 2 mel_bins Mel spectrogram 2 1 1 2 1 1 batch_size 1 1 n_fft time_steps n_fft 1 Logmel', 'frequency bins'), 'start') (('you', 'later stage'), 'warn') (('5 allways_apply', 'False low_alpha'), 'bool') (('model', 'input audio'), 'help') (('so experiment', '5 models'), 'package') (('pt Public score', 'initalize_spectral_model'), 'DEVICE') (('compute_normalized_energy au hop_size window_size probs_comp uniform', 'np'), 'raise') (('noises', 'noise alpha LowFrequency CutOff pythonclass LowFrequencyMask au 1 audiomentations'), 'au') (('model', 'DF Train Tips audiomentations package https thanks github'), 'create') (('We', 'new audio'), 'have') (('4', 'initalize_spectral_model'), 'use') (('5 min_cutoff', 'False max_cutoff'), 'bool') (('which', 'Mixup'), 'audio') (('Feature Extraction Other Config', 'Config End ratio Spectrogram extractor Logmel feature extractor Spec https Other Downsampled github'), 'Config') (('Multi Sample DropoutOriginally', 'paper https arxiv'), 'work') (('min_cutoff min_cutoff', 'np'), 'apply') (('models', 'clipwise framewise model'), 'device') (('5', 'Blend'), 'use') (('high_alpha high_alpha', 'np'), 'apply') (('dim Energy 5 dim 0 trimmingI', '1 second'), 'create') ", "extra": "['test']"}